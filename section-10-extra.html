<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CA DMV Practice Test -- Financial Responsibility, Insurance Requirements, and Collisions</title>
<style>
*, *::before, *::after {
  box-sizing: border-box;
}

body {
  margin: 0;
  padding: 0;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
  background: #f5f7fa;
  color: #1a1a2e;
  line-height: 1.6;
}

#app {
  max-width: 800px;
  margin: 0 auto;
  padding: 16px;
}

/* Header */
header {
  text-align: center;
  margin-bottom: 16px;
}

header h1 {
  font-size: 1.5rem;
  margin: 0 0 12px 0;
  color: #003366;
}

#progress-bar-container {
  width: 100%;
  height: 8px;
  background: #dde1e7;
  border-radius: 4px;
  overflow: hidden;
  margin-bottom: 10px;
}

#progress-bar {
  height: 100%;
  width: 0%;
  background: linear-gradient(90deg, #2e7d32, #43a047);
  border-radius: 4px;
  transition: width 0.3s ease;
}

#score-display {
  display: flex;
  justify-content: center;
  gap: 12px;
  flex-wrap: wrap;
}

.score-chip {
  display: inline-block;
  padding: 4px 12px;
  border-radius: 16px;
  font-size: 0.85rem;
  font-weight: 600;
}

.correct-chip {
  background: #e8f5e9;
  color: #2e7d32;
}

.incorrect-chip {
  background: #ffebee;
  color: #c62828;
}

.unanswered-chip {
  background: #e3f2fd;
  color: #1565c0;
}

/* Filter bar */
#filter-bar {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  align-items: center;
  margin-bottom: 20px;
  padding: 12px;
  background: #ffffff;
  border-radius: 8px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.08);
}

.filter-group {
  display: flex;
  align-items: center;
  gap: 4px;
}

.filter-group label {
  font-size: 0.8rem;
  font-weight: 600;
  color: #555;
  white-space: nowrap;
}

.filter-group select {
  font-size: 0.85rem;
  padding: 4px 8px;
  border: 1px solid #ccc;
  border-radius: 4px;
  background: #fff;
  max-width: 180px;
}

#btn-shuffle, #btn-reset {
  font-size: 0.85rem;
  padding: 5px 14px;
  border: 1px solid #ccc;
  border-radius: 4px;
  background: #fff;
  cursor: pointer;
  font-weight: 600;
  color: #333;
  transition: background 0.2s;
}

#btn-shuffle:hover, #btn-reset:hover {
  background: #eee;
}

/* Question container */
#question-container {
  background: #ffffff;
  border-radius: 12px;
  padding: 24px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}

#question-meta {
  display: flex;
  align-items: center;
  gap: 10px;
  flex-wrap: wrap;
  margin-bottom: 16px;
}

#q-counter {
  font-weight: 700;
  font-size: 0.95rem;
  color: #003366;
}

.meta-tag {
  font-size: 0.75rem;
  padding: 2px 10px;
  border-radius: 12px;
  background: #e8eaf6;
  color: #283593;
  font-weight: 600;
}

/* Image */
#q-image-wrapper {
  text-align: center;
  margin-bottom: 16px;
}

#q-image {
  max-width: 100%;
  max-height: 360px;
  border-radius: 8px;
  border: 1px solid #ddd;
  object-fit: contain;
}

/* Question text */
#q-text {
  font-size: 1.1rem;
  font-weight: 500;
  margin-bottom: 20px;
  line-height: 1.5;
}

/* Choices */
#choices-container {
  display: flex;
  flex-direction: column;
  gap: 8px;
  margin-bottom: 20px;
}

.choice-btn {
  display: flex;
  align-items: flex-start;
  gap: 10px;
  width: 100%;
  padding: 12px 16px;
  border: 2px solid #dde1e7;
  border-radius: 8px;
  background: #fafbfc;
  cursor: pointer;
  text-align: left;
  font-size: 1rem;
  line-height: 1.4;
  transition: border-color 0.15s, background 0.15s;
}

.choice-btn:hover:not(:disabled) {
  border-color: #90caf9;
  background: #e3f2fd;
}

.choice-btn:disabled {
  cursor: default;
  opacity: 0.55;
  pointer-events: none;
}

.choice-btn:disabled.choice-correct,
.choice-btn:disabled.choice-incorrect {
  opacity: 1;
}

.choice-letter {
  font-weight: 700;
  color: #555;
  min-width: 24px;
  flex-shrink: 0;
}

.choice-text {
  flex: 1;
}

.choice-selected {
  border-color: #1976d2;
  background: #e3f2fd;
}

.choice-correct {
  border-color: #2e7d32 !important;
  background: #e8f5e9 !important;
}

.choice-correct .choice-letter {
  color: #2e7d32;
}

.choice-incorrect {
  border-color: #c62828 !important;
  background: #ffebee !important;
}

.choice-incorrect .choice-letter {
  color: #c62828;
}

/* Feedback */
#feedback {
  margin-bottom: 16px;
  padding: 12px 16px;
  border-radius: 8px;
  font-size: 0.95rem;
}

.feedback-correct {
  color: #2e7d32;
  font-weight: 700;
  font-size: 1.05rem;
}

.feedback-incorrect {
  color: #c62828;
  font-weight: 700;
  font-size: 1.05rem;
}

.feedback-neutral {
  color: #555;
  font-weight: 600;
}

#explanation {
  margin-top: 10px;
  padding: 12px 16px;
  background: #fff8e1;
  border-left: 4px solid #ffa000;
  border-radius: 4px;
  font-size: 0.95rem;
  line-height: 1.5;
}

/* Buttons */
#action-buttons {
  text-align: center;
  margin-bottom: 16px;
}

.btn-primary {
  padding: 10px 28px;
  font-size: 1rem;
  font-weight: 600;
  color: #fff;
  background: #1976d2;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  transition: background 0.2s;
  margin: 4px;
}

.btn-primary:hover {
  background: #1565c0;
}

#nav-buttons {
  display: flex;
  justify-content: space-between;
}

.btn-nav {
  padding: 10px 24px;
  font-size: 0.95rem;
  font-weight: 600;
  color: #333;
  background: #e0e0e0;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  transition: background 0.2s;
}

.btn-nav:hover:not(:disabled) {
  background: #bdbdbd;
}

.btn-nav:disabled {
  opacity: 0.4;
  cursor: default;
}

/* Summary */
#summary-container {
  background: #ffffff;
  border-radius: 12px;
  padding: 32px 24px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  text-align: center;
}

#summary-container h2 {
  color: #003366;
  margin-top: 0;
}

.summary-big-score {
  font-size: 2.5rem;
  font-weight: 800;
  color: #1a1a2e;
  margin: 16px 0 4px;
}

.summary-pct {
  font-size: 1.3rem;
  font-weight: 700;
  margin-bottom: 16px;
}

.summary-pass { color: #2e7d32; }
.summary-fail { color: #c62828; }

.summary-detail {
  margin-bottom: 24px;
}

.breakdown-table {
  width: 100%;
  border-collapse: collapse;
  margin: 16px 0 24px;
  font-size: 0.9rem;
  text-align: left;
}

.breakdown-table th {
  background: #e8eaf6;
  padding: 8px 12px;
  font-weight: 700;
  color: #283593;
}

.breakdown-table td {
  padding: 8px 12px;
  border-bottom: 1px solid #eee;
}

/* Empty state */
#empty-state {
  text-align: center;
  padding: 48px 24px;
  color: #777;
  font-size: 1.1rem;
}

/* Back link */
.back-link {
  display: inline-block;
  margin-bottom: 8px;
  font-size: 0.9rem;
  color: #1976d2;
  text-decoration: none;
  font-weight: 600;
}

.back-link:hover {
  text-decoration: underline;
}

/* Extra questions link */
.extra-link {
  display: block;
  text-align: center;
  margin-top: 24px;
  padding: 14px 24px;
  background: #ffffff;
  border: 2px solid #1976d2;
  border-radius: 12px;
  color: #1976d2;
  font-weight: 600;
  font-size: 1rem;
  text-decoration: none;
  transition: background 0.2s, color 0.2s;
}

.extra-link:hover {
  background: #1976d2;
  color: #ffffff;
}

/* Responsive */
@media (max-width: 600px) {
  #app { padding: 8px; }
  header h1 { font-size: 1.2rem; }
  #question-container { padding: 16px; }
  #q-text { font-size: 1rem; }
  .choice-btn { padding: 10px 12px; font-size: 0.95rem; }
  #filter-bar { gap: 6px; padding: 8px; }
  .filter-group select { max-width: 120px; }
  .summary-big-score { font-size: 2rem; }
}

</style>
</head>
<body>

<div id="app">
  <!-- Header -->
  <header id="header">
    <a href="index.html" class="back-link">&larr; All Sections</a>
    <h1>CA DMV Practice Test -- Financial Responsibility, Insurance Requirements, and Collisions</h1>
    <div id="progress-bar-container">
      <div id="progress-bar"></div>
    </div>
    <div id="score-display">
      <span id="score-correct" class="score-chip correct-chip">Correct: 0</span>
      <span id="score-incorrect" class="score-chip incorrect-chip">Incorrect: 0</span>
      <span id="score-unanswered" class="score-chip unanswered-chip">Remaining: 0</span>
    </div>
  </header>

  <!-- Filter controls -->
  <div id="filter-bar">
    <div class="filter-group" style="display:none;">
      <label for="filter-section">Section:</label>
      <select id="filter-section"><option value="all">All Sections</option></select>
    </div>
    <div class="filter-group">
      <label for="filter-topic">Topic:</label>
      <select id="filter-topic"><option value="all">All Topics</option></select>
    </div>
    <div class="filter-group">
      <label for="filter-difficulty">Difficulty:</label>
      <select id="filter-difficulty"><option value="all">All</option></select>
    </div>
    <div class="filter-group">
      <label for="filter-type">Type:</label>
      <select id="filter-type"><option value="all">All</option></select>
    </div>
    <button id="btn-shuffle" title="Shuffle questions">Shuffle</button>
    <button id="btn-reset" title="Reset all answers">Reset</button>
  </div>

  <!-- Question slide -->
  <div id="question-container" style="display:none;">
    <div id="question-meta">
      <span id="q-counter">Question 1 of 1</span>
      <span id="q-section-label" class="meta-tag"></span>
      <span id="q-topic-label" class="meta-tag"></span>
      <span id="q-difficulty-label" class="meta-tag"></span>
    </div>

    <div id="q-image-wrapper" style="display:none;">
      <img id="q-image" alt="Question image" />
    </div>

    <div id="q-text"></div>

    <div id="choices-container"></div>

    <div id="feedback" style="display:none;">
      <div id="feedback-text"></div>
      <div id="explanation" style="display:none;"></div>
    </div>

    <div id="action-buttons">
      <button id="btn-show-answer" class="btn-primary">Check Answer</button>
    </div>

    <div id="nav-buttons">
      <button id="btn-prev" class="btn-nav" disabled>&larr; Previous</button>
      <button id="btn-next" class="btn-nav">Next &rarr;</button>
    </div>
  </div>

  <!-- Summary page -->
  <div id="summary-container" style="display:none;">
    <h2>Test Complete</h2>
    <div id="summary-score"></div>
    <div id="summary-breakdown"></div>
    <button id="btn-review" class="btn-primary">Review Answers</button>
    <button id="btn-restart" class="btn-primary">Restart</button>
  </div>

  <!-- Empty state -->
  <div id="empty-state" style="display:none;">
    <p>No questions match the current filters. Try adjusting your selection.</p>
  </div>

  <!-- Extra questions link -->
  
</div>

<script>
'use strict';
(function() {

/* ---- Data ---- */
var ALL_QUESTIONS = JSON.parse('[{"question_id": "q-sec10-driving-without-insurance-002", "question_type": "true_false", "question_text": "If you are in a collision without proper insurance, your driving privilege can be suspended even if the collision was not your fault.", "choices": [{"label": "True", "text": "True"}, {"label": "False", "text": "False"}], "correct_answer": "True", "explanation": "Your driving privilege will be suspended for up to four years if you are in a collision and do not have proper insurance coverage. It does not matter who was at fault -- the suspension applies regardless.", "section_id": "section-10", "topic": "Driving Without Insurance", "subtopic": "Suspension and California Insurance Proof Certificate", "difficulty": "medium", "image_id": null, "image_file": null, "source_facts": ["For the suspension due to being in a collision without proper insurance coverage, it does not matter who was at fault."], "validation_status": "pass", "validation_notes": null, "ranking": {"frequency": 8, "quality": 8, "importance": 8, "uniqueness": 6, "composite": 7.6, "rank": 19}, "_image_data_uri": null}, {"question_id": "q-sec10-insurance-requirements-003", "question_type": "multiple_choice", "question_text": "If you are involved in a collision, to whom must you show your proof of financial responsibility (insurance)?", "choices": [{"label": "A", "text": "Only to law enforcement officers"}, {"label": "B", "text": "Only to your insurance company"}, {"label": "C", "text": "To the other drivers involved in the collision"}, {"label": "D", "text": "Only to the DMV within 10 days"}], "correct_answer": "C", "explanation": "If you get into a collision, you must show proof of financial responsibility (insurance) to the other drivers involved in the collision.", "section_id": "section-10", "topic": "Insurance Requirements", "subtopic": "Proof of Financial Responsibility (Insurance)", "difficulty": "easy", "image_id": null, "image_file": null, "source_facts": ["If you get into a collision, you must show proof of financial responsibility (insurance) to the other drivers involved in the collision."], "validation_status": "pass", "validation_notes": null, "ranking": {"frequency": 8, "quality": 8, "importance": 7, "uniqueness": 7, "composite": 7.6, "rank": 20}, "_image_data_uri": null}, {"question_id": "q-sec10-collisions-026", "question_type": "multiple_choice", "question_text": "What happens if you fail to file a DMV collision report when required?", "choices": [{"label": "A", "text": "Your driving privilege will be suspended"}, {"label": "B", "text": "You will receive a fine of up to $1,000"}, {"label": "C", "text": "You will be required to retake the written test"}, {"label": "D", "text": "Points will be added to your driving record"}], "correct_answer": "A", "explanation": "Your driving privilege will be suspended if you fail to file a DMV collision report when required.", "section_id": "section-10", "topic": "Collisions", "subtopic": "Reporting a Collision", "difficulty": "medium", "image_id": null, "image_file": null, "source_facts": ["Your driving privilege will be suspended if you fail to file a DMV collision report."], "validation_status": "pass", "validation_notes": null, "ranking": {"frequency": 7, "quality": 8, "importance": 8, "uniqueness": 7, "composite": 7.5, "rank": 21}, "_image_data_uri": null}, {"question_id": "q-sec10-collisions-013", "question_type": "multiple_choice", "question_text": "Which of the following must you show to the other driver, law enforcement, and others involved in a collision?", "choices": [{"label": "A", "text": "Driver\'s license, vehicle registration card, insurance information, and current address"}, {"label": "B", "text": "Driver\'s license and vehicle registration card only"}, {"label": "C", "text": "Insurance information and Social Security number"}, {"label": "D", "text": "Driver\'s license and proof of employment"}], "correct_answer": "A", "explanation": "You must show your driver\'s license, vehicle registration card, insurance information, and current address to the other driver, law enforcement officer, and anyone else involved in the collision.", "section_id": "section-10", "topic": "Collisions", "subtopic": "What to Do if You Are in a Collision", "difficulty": "medium", "image_id": null, "image_file": null, "source_facts": ["Show your driver\'s license to the other driver, law enforcement officer, and anyone else involved in the collision.", "Show your vehicle registration card to the other driver, law enforcement officer, and anyone else involved in the collision.", "Show your insurance information to the other driver, law enforcement officer, and anyone else involved in the collision.", "Show your current address to the other driver, law enforcement officer, and anyone else involved in the collision."], "validation_status": "pass", "validation_notes": null, "ranking": {"frequency": 8, "quality": 8, "importance": 7, "uniqueness": 6, "composite": 7.4, "rank": 22}, "_image_data_uri": null}, {"question_id": "q-sec10-collisions-018", "question_type": "multiple_choice", "question_text": "What should you do if you injure or kill an animal while driving?", "choices": [{"label": "A", "text": "Leave the scene since animals are not covered by collision rules"}, {"label": "B", "text": "Try to move the injured animal off the road"}, {"label": "C", "text": "Report it to the DMV within 10 days"}, {"label": "D", "text": "Call the nearest humane society or law enforcement"}], "correct_answer": "D", "explanation": "If you kill or injure an animal, call the nearest humane society or law enforcement. Do not try to move an injured animal.", "section_id": "section-10", "topic": "Collisions", "subtopic": "What to Do if You Are in a Collision", "difficulty": "medium", "image_id": null, "image_file": null, "source_facts": ["If you kill or injure an animal, call the nearest humane society or law enforcement.", "Do not try to move an injured animal."], "validation_status": "pass", "validation_notes": null, "ranking": {"frequency": 7, "quality": 8, "importance": 7, "uniqueness": 8, "composite": 7.4, "rank": 23}, "_image_data_uri": null}, {"question_id": "q-sec10-collisions-025", "question_type": "true_false", "question_text": "You must file a DMV collision report even if the collision happened on private property.", "choices": [{"label": "True", "text": "True"}, {"label": "False", "text": "False"}], "correct_answer": "True", "explanation": "You must file the DMV collision report even if the collision happened on private property, as long as it meets the reporting thresholds (more than $1,000 in property damage or anyone was injured or killed).", "section_id": "section-10", "topic": "Collisions", "subtopic": "Reporting a Collision", "difficulty": "hard", "image_id": null, "image_file": null, "source_facts": ["You must file the DMV collision report even if the collision happened on private property."], "validation_status": "pass", "validation_notes": null, "ranking": {"frequency": 7, "quality": 8, "importance": 7, "uniqueness": 7, "composite": 7.2, "rank": 25}, "_image_data_uri": null}, {"question_id": "q-sec10-driving-without-insurance-003", "question_type": "multiple_choice", "question_text": "How can you get your driver\'s license back after a suspension for being in a collision without insurance?", "choices": [{"label": "A", "text": "Provide and maintain a California Insurance Proof Certificate (SR 22/SR 1P) during the last three years of the suspension"}, {"label": "B", "text": "Wait for the full four-year suspension to end"}, {"label": "C", "text": "Pay a reinstatement fee to the DMV"}, {"label": "D", "text": "Complete a defensive driving course"}], "correct_answer": "A", "explanation": "You can get your driver\'s license back during the last three years of the suspension if you provide a California Insurance Proof Certificate (SR 22/SR 1P) and maintain it during the three-year period.", "section_id": "section-10", "topic": "Driving Without Insurance", "subtopic": "Suspension and California Insurance Proof Certificate", "difficulty": "hard", "image_id": null, "image_file": null, "source_facts": ["You can get your driver\'s license back during the last three years of the suspension if you provide a California Insurance Proof Certificate (SR 22/SR 1P) and maintain it during the three-year period."], "validation_status": "pass", "validation_notes": null, "ranking": {"frequency": 7, "quality": 8, "importance": 7, "uniqueness": 7, "composite": 7.2, "rank": 26}, "_image_data_uri": null}, {"question_id": "q-sec10-insurance-requirements-001", "question_type": "true_false", "question_text": "You must have your proof of financial responsibility (insurance) with you when you drive.", "choices": [{"label": "True", "text": "True"}, {"label": "False", "text": "False"}], "correct_answer": "True", "explanation": "California law requires you to carry proof of financial responsibility (insurance) whenever you drive. You must be able to show it if asked by law enforcement or other parties in a collision.", "section_id": "section-10", "topic": "Insurance Requirements", "subtopic": "Proof of Financial Responsibility (Insurance)", "difficulty": "easy", "image_id": null, "image_file": null, "source_facts": ["You must have your proof of financial responsibility (insurance) when you drive."], "validation_status": "pass", "validation_notes": null, "ranking": {"frequency": 8, "quality": 6, "importance": 8, "uniqueness": 6, "composite": 7.1, "rank": 27}, "_image_data_uri": null}, {"question_id": "q-sec10-collisions-002", "question_type": "true_false", "question_text": "You should drive close to collision scenes so you can help if anyone is injured.", "choices": [{"label": "True", "text": "True"}, {"label": "False", "text": "False"}], "correct_answer": "False", "explanation": "This is false. You should avoid driving near collisions, if possible. If anyone is injured, they will get help faster if other vehicles are not blocking the road.", "section_id": "section-10", "topic": "Collisions", "subtopic": "Collision Awareness and Avoidance", "difficulty": "easy", "image_id": null, "image_file": null, "source_facts": ["Avoid driving near collisions, if possible.", "If anyone is injured, they will get help faster if other vehicles are not blocking the road."], "validation_status": "pass", "validation_notes": null, "ranking": {"frequency": 7, "quality": 7, "importance": 8, "uniqueness": 6, "composite": 7.0, "rank": 29}, "_image_data_uri": null}, {"question_id": "q-sec10-collisions-008", "question_type": "multiple_choice", "question_text": "Which of the following is a common cause of collisions?", "choices": [{"label": "A", "text": "Driving with your headlights on during the day"}, {"label": "B", "text": "Driving with passengers in the vehicle"}, {"label": "C", "text": "Driving a vehicle with manual transmission"}, {"label": "D", "text": "A vehicle traveling faster or slower than the flow of traffic"}], "correct_answer": "D", "explanation": "A vehicle traveling faster or slower than the flow of traffic is listed as one of the most common causes of collisions. Matching the flow of traffic helps prevent collisions.", "section_id": "section-10", "topic": "Collisions", "subtopic": "Causes of Collisions", "difficulty": "medium", "image_id": null, "image_file": null, "source_facts": ["A vehicle traveling faster or slower than the flow of traffic is a common cause of collisions."], "validation_status": "pass", "validation_notes": null, "ranking": {"frequency": 7, "quality": 8, "importance": 7, "uniqueness": 6, "composite": 7.0, "rank": 30}, "_image_data_uri": null}, {"question_id": "q-sec10-insurance-requirements-004", "question_type": "multiple_choice", "question_text": "What is the minimum insurance coverage required for a single death or injury in California?", "choices": [{"label": "A", "text": "$15,000"}, {"label": "B", "text": "$25,000"}, {"label": "C", "text": "$30,000"}, {"label": "D", "text": "$60,000"}], "correct_answer": "C", "explanation": "Your insurance must cover at least $30,000 for a single death or injury. The $15,000 amount is the minimum for property damage, and $60,000 is the minimum for death or injury to more than one person.", "section_id": "section-10", "topic": "Insurance Requirements", "subtopic": "Minimum Coverage Amounts", "difficulty": "medium", "image_id": null, "image_file": null, "source_facts": ["Your insurance must cover at least $30,000 for a single death or injury."], "validation_status": "pass", "validation_notes": null, "ranking": {"frequency": 8, "quality": 7, "importance": 7, "uniqueness": 5, "composite": 6.9, "rank": 31}, "_image_data_uri": null}, {"question_id": "q-sec10-insurance-requirements-005", "question_type": "multiple_choice", "question_text": "What is the minimum insurance coverage required for death or injury to more than one person in California?", "choices": [{"label": "A", "text": "$30,000"}, {"label": "B", "text": "$45,000"}, {"label": "C", "text": "$50,000"}, {"label": "D", "text": "$60,000"}], "correct_answer": "D", "explanation": "Your insurance must cover at least $60,000 for death or injury to more than one person. This is double the $30,000 minimum required for a single death or injury.", "section_id": "section-10", "topic": "Insurance Requirements", "subtopic": "Minimum Coverage Amounts", "difficulty": "medium", "image_id": null, "image_file": null, "source_facts": ["Your insurance must cover at least $60,000 for death or injury to more than one person."], "validation_status": "pass", "validation_notes": null, "ranking": {"frequency": 8, "quality": 7, "importance": 7, "uniqueness": 5, "composite": 6.9, "rank": 32}, "_image_data_uri": null}, {"question_id": "q-sec10-insurance-requirements-006", "question_type": "multiple_choice", "question_text": "What is the minimum insurance coverage required for property damage in California?", "choices": [{"label": "A", "text": "$5,000"}, {"label": "B", "text": "$10,000"}, {"label": "C", "text": "$30,000"}, {"label": "D", "text": "$15,000"}], "correct_answer": "D", "explanation": "Your insurance must cover at least $15,000 for property damage. This is separate from the bodily injury coverage requirements of $30,000/$60,000.", "section_id": "section-10", "topic": "Insurance Requirements", "subtopic": "Minimum Coverage Amounts", "difficulty": "medium", "image_id": null, "image_file": null, "source_facts": ["Your insurance must cover at least $15,000 for property damage."], "validation_status": "pass", "validation_notes": null, "ranking": {"frequency": 8, "quality": 7, "importance": 7, "uniqueness": 5, "composite": 6.9, "rank": 33}, "_image_data_uri": null}, {"question_id": "q-sec10-collisions-036", "question_type": "scenario", "question_text": "While driving, you accidentally hit a dog that ran into the road. The dog appears injured but is still alive. What should you do?", "choices": [{"label": "A", "text": "Move the dog off the road to prevent further harm"}, {"label": "B", "text": "Continue driving since it was not your fault"}, {"label": "C", "text": "Call the nearest humane society or law enforcement and do not try to move the injured animal"}, {"label": "D", "text": "Leave a note on the nearest telephone pole with your contact information"}], "correct_answer": "C", "explanation": "If you kill or injure an animal, call the nearest humane society or law enforcement. Do not try to move an injured animal, as this could cause further injury to the animal or to yourself.", "section_id": "section-10", "topic": "Collisions", "subtopic": "What to Do if You Are in a Collision", "difficulty": "medium", "image_id": null, "image_file": null, "source_facts": ["If you kill or injure an animal, call the nearest humane society or law enforcement.", "Do not try to move an injured animal."], "validation_status": "pass", "validation_notes": null, "ranking": {"frequency": 7, "quality": 8, "importance": 7, "uniqueness": 5, "composite": 6.8, "rank": 34}, "_image_data_uri": null}, {"question_id": "q-sec10-collisions-037", "question_type": "scenario", "question_text": "You are involved in a minor fender-bender collision. No one is injured and both vehicles have only minor scratches. What should you do at the scene?", "choices": [{"label": "A", "text": "Exchange driver\'s licenses, vehicle registration cards, insurance information, and current addresses with the other driver, then move vehicles out of traffic and call 911"}, {"label": "B", "text": "Wait for law enforcement to arrive before moving your vehicle"}, {"label": "C", "text": "Exchange phone numbers only and leave the scene"}, {"label": "D", "text": "File a DMV report immediately from the scene"}], "correct_answer": "A", "explanation": "If you are in a collision and no one is hurt, move your vehicle out of traffic and then call 911. You must show your driver\'s license, vehicle registration card, insurance information, and current address to the other driver and anyone else involved.", "section_id": "section-10", "topic": "Collisions", "subtopic": "What to Do if You Are in a Collision", "difficulty": "medium", "image_id": null, "image_file": null, "source_facts": ["Move your vehicle out of traffic if no one is hurt. Then call 911.", "Show your driver\'s license to the other driver, law enforcement officer, and anyone else involved in the collision.", "Show your vehicle registration card to the other driver, law enforcement officer, and anyone else involved in the collision.", "Show your insurance information to the other driver, law enforcement officer, and anyone else involved in the collision.", "Show your current address to the other driver, law enforcement officer, and anyone else involved in the collision."], "validation_status": "pass", "validation_notes": null, "ranking": {"frequency": 7, "quality": 8, "importance": 7, "uniqueness": 5, "composite": 6.8, "rank": 35}, "_image_data_uri": null}, {"question_id": "q-sec10-collisions-021", "question_type": "multiple_choice", "question_text": "What is the property damage threshold that requires you to report a collision to the DMV?", "choices": [{"label": "A", "text": "More than $500"}, {"label": "B", "text": "More than $750"}, {"label": "C", "text": "More than $1,000"}, {"label": "D", "text": "More than $2,500"}], "correct_answer": "C", "explanation": "You must report a collision to DMV within 10 days if the collision caused more than $1,000 in damage to property.", "section_id": "section-10", "topic": "Collisions", "subtopic": "Reporting a Collision", "difficulty": "medium", "image_id": null, "image_file": null, "source_facts": ["If you are in a collision, you must report it to DMV within 10 days if the collision caused more than $1,000 in damage to property."], "validation_status": "pass", "validation_notes": null, "ranking": {"frequency": 8, "quality": 7, "importance": 7, "uniqueness": 4, "composite": 6.7, "rank": 36}, "_image_data_uri": null}, {"question_id": "q-sec10-collisions-012", "question_type": "multiple_choice", "question_text": "If you are in a collision and no one is hurt, what should you do before calling 911?", "choices": [{"label": "A", "text": "Move your vehicle out of traffic"}, {"label": "B", "text": "Exchange insurance information with the other driver"}, {"label": "C", "text": "Take photographs of the damage"}, {"label": "D", "text": "Wait for a police officer to arrive"}], "correct_answer": "A", "explanation": "Move your vehicle out of traffic if no one is hurt. Then call 911. This helps keep traffic flowing and prevents additional collisions.", "section_id": "section-10", "topic": "Collisions", "subtopic": "What to Do if You Are in a Collision", "difficulty": "medium", "image_id": null, "image_file": null, "source_facts": ["Move your vehicle out of traffic if no one is hurt. Then call 911."], "validation_status": "pass", "validation_notes": null, "ranking": {"frequency": 7, "quality": 7, "importance": 7, "uniqueness": 5, "composite": 6.6, "rank": 37}, "_image_data_uri": null}, {"question_id": "q-sec10-collisions-022", "question_type": "true_false", "question_text": "You do not need to report a collision to the DMV if the injuries were minor.", "choices": [{"label": "True", "text": "True"}, {"label": "False", "text": "False"}], "correct_answer": "False", "explanation": "This is false. The requirement to report a collision to DMV within 10 days applies if anyone was injured or killed, even if the injuries were minor.", "section_id": "section-10", "topic": "Collisions", "subtopic": "Reporting a Collision", "difficulty": "medium", "image_id": null, "image_file": null, "source_facts": ["The requirement to report a collision to DMV applies even if the injuries were minor."], "validation_status": "pass", "validation_notes": null, "ranking": {"frequency": 7, "quality": 7, "importance": 7, "uniqueness": 5, "composite": 6.6, "rank": 38}, "_image_data_uri": null}, {"question_id": "q-sec10-collisions-024", "question_type": "true_false", "question_text": "You must file a DMV collision report whether or not you caused the collision.", "choices": [{"label": "True", "text": "True"}, {"label": "False", "text": "False"}], "correct_answer": "True", "explanation": "You (or your representative) must file a Report of Traffic Accident Occurring in California (SR 1) with DMV whether or not you caused the collision.", "section_id": "section-10", "topic": "Collisions", "subtopic": "Reporting a Collision", "difficulty": "medium", "image_id": null, "image_file": null, "source_facts": ["You (or your representative) must file a collision report to DMV whether or not you caused the collision."], "validation_status": "pass", "validation_notes": null, "ranking": {"frequency": 7, "quality": 7, "importance": 7, "uniqueness": 5, "composite": 6.6, "rank": 39}, "_image_data_uri": null}, {"question_id": "q-sec10-collisions-029", "question_type": "multiple_choice", "question_text": "If you are involved in a collision resulting in $1,000 or more in damage, whose responsibility is it to report the collision to the DMV?", "choices": [{"label": "A", "text": "Only the driver who caused the collision"}, {"label": "B", "text": "The responding law enforcement officer"}, {"label": "C", "text": "Your responsibility, regardless of who caused the collision"}, {"label": "D", "text": "Your insurance company"}], "correct_answer": "C", "explanation": "If you are involved in a collision resulting in $1,000 in damage, or where anyone is injured or dies, it is your responsibility to report the collision to DMV. It does not matter who caused the collision.", "section_id": "section-10", "topic": "Collisions", "subtopic": "Collisions on Your Driver\'s Record", "difficulty": "medium", "image_id": null, "image_file": null, "source_facts": ["If you are involved in a collision resulting in $1,000 in damage, it is your responsibility to report the collision to DMV.", "It does not matter who caused the collision."], "validation_status": "pass", "validation_notes": null, "ranking": {"frequency": 7, "quality": 7, "importance": 7, "uniqueness": 5, "composite": 6.6, "rank": 40}, "_image_data_uri": null}, {"question_id": "q-sec10-collisions-023", "question_type": "multiple_choice", "question_text": "What form must each driver file with the DMV after a reportable collision?", "choices": [{"label": "A", "text": "Report of Traffic Accident Occurring in California (SR 1)"}, {"label": "B", "text": "California Insurance Proof Certificate (SR 22)"}, {"label": "C", "text": "Vehicle Damage Report (VDR 1)"}, {"label": "D", "text": "Collision Notification Form (CNF 10)"}], "correct_answer": "A", "explanation": "Each driver must file a Report of Traffic Accident Occurring in California (SR 1) with DMV at dmv.ca.gov/accidentreport.", "section_id": "section-10", "topic": "Collisions", "subtopic": "Reporting a Collision", "difficulty": "hard", "image_id": null, "image_file": null, "source_facts": ["Each driver must file a Report of Traffic Accident Occurring in California (SR 1) with DMV at dmv.ca.gov/accidentreport."], "validation_status": "pass", "validation_notes": null, "ranking": {"frequency": 6, "quality": 7, "importance": 6, "uniqueness": 7, "composite": 6.5, "rank": 41}, "_image_data_uri": null}, {"question_id": "q-sec10-collisions-027", "question_type": "true_false", "question_text": "Law enforcement will file a DMV collision report on your behalf.", "choices": [{"label": "True", "text": "True"}, {"label": "False", "text": "False"}], "correct_answer": "False", "explanation": "Law enforcement will not make a DMV collision report for you. It is your responsibility to file the Report of Traffic Accident Occurring in California (SR 1) with DMV.", "section_id": "section-10", "topic": "Collisions", "subtopic": "Reporting a Collision", "difficulty": "hard", "image_id": null, "image_file": null, "source_facts": ["Law enforcement will not make a DMV collision report for you."], "validation_status": "pass", "validation_notes": null, "ranking": {"frequency": 6, "quality": 7, "importance": 6, "uniqueness": 7, "composite": 6.5, "rank": 42}, "_image_data_uri": null}, {"question_id": "q-sec10-insurance-requirements-010", "question_type": "multiple_choice", "question_text": "At what age do California drivers take on their own financial responsibility?", "choices": [{"label": "A", "text": "16 years old"}, {"label": "B", "text": "17 years old"}, {"label": "C", "text": "21 years old"}, {"label": "D", "text": "18 years old"}], "correct_answer": "D", "explanation": "Drivers who are 18 years old and older take on their own financial responsibility. Before age 18, parents or guardians are financially responsible.", "section_id": "section-10", "topic": "Insurance Requirements", "subtopic": "Financial Responsibility by Age", "difficulty": "medium", "image_id": null, "image_file": null, "source_facts": ["Drivers who are 18 years old and older take on their own financial responsibility."], "validation_status": "pass", "validation_notes": null, "ranking": {"frequency": 7, "quality": 7, "importance": 6, "uniqueness": 6, "composite": 6.5, "rank": 43}, "_image_data_uri": null}, {"question_id": "q-sec10-collisions-017", "question_type": "multiple_choice", "question_text": "What information should you include in the note left on a parked car you hit if you cannot find the owner?", "choices": [{"label": "A", "text": "Your insurance policy number and agent\'s name"}, {"label": "B", "text": "Your name, phone number, and address"}, {"label": "C", "text": "Your driver\'s license number and vehicle make"}, {"label": "D", "text": "A description of the damage and the time of the collision"}], "correct_answer": "B", "explanation": "If you cannot find the owner of a vehicle or property you hit, leave a note with your name, phone number, and address securely attached to the vehicle or property.", "section_id": "section-10", "topic": "Collisions", "subtopic": "What to Do if You Are in a Collision", "difficulty": "medium", "image_id": null, "image_file": null, "source_facts": ["If you cannot find the owner after hitting a parked car or other property, leave a note with your name, phone number, and address."], "validation_status": "pass", "validation_notes": null, "ranking": {"frequency": 7, "quality": 7, "importance": 7, "uniqueness": 4, "composite": 6.4, "rank": 44}, "_image_data_uri": null}, {"question_id": "q-sec10-collisions-003", "question_type": "multiple_choice", "question_text": "Why should you avoid driving near the scene of a collision?", "choices": [{"label": "A", "text": "Your vehicle might be impounded by law enforcement"}, {"label": "B", "text": "Injured people will get help faster if other vehicles are not blocking the road"}, {"label": "C", "text": "You could receive a traffic citation for slowing down"}, {"label": "D", "text": "Your insurance rates will increase if you are near a collision scene"}], "correct_answer": "B", "explanation": "You should avoid driving near collisions because if anyone is injured, they will get help faster if other vehicles are not blocking the road.", "section_id": "section-10", "topic": "Collisions", "subtopic": "Collision Awareness and Avoidance", "difficulty": "easy", "image_id": null, "image_file": null, "source_facts": ["If anyone is injured, they will get help faster if other vehicles are not blocking the road."], "validation_status": "pass", "validation_notes": null, "ranking": {"frequency": 6, "quality": 7, "importance": 7, "uniqueness": 5, "composite": 6.3, "rank": 45}, "_image_data_uri": null}, {"question_id": "q-sec10-insurance-requirements-009", "question_type": "true_false", "question_text": "Parents or guardians must pay for damages if a driver younger than 18 years old is involved in a collision.", "choices": [{"label": "True", "text": "True"}, {"label": "False", "text": "False"}], "correct_answer": "True", "explanation": "Parents or guardians take on financial responsibility for drivers younger than 18 years old and are responsible for paying damages if the minor driver is involved in a collision.", "section_id": "section-10", "topic": "Insurance Requirements", "subtopic": "Financial Responsibility by Age", "difficulty": "easy", "image_id": null, "image_file": null, "source_facts": ["Parents or guardians pay for damages if a driver younger than 18 years old is involved in a collision."], "validation_status": "pass", "validation_notes": null, "ranking": {"frequency": 7, "quality": 6, "importance": 7, "uniqueness": 5, "composite": 6.3, "rank": 46}, "_image_data_uri": null}, {"question_id": "q-sec10-collisions-015", "question_type": "true_false", "question_text": "Only you personally can file a collision report to law enforcement; your insurance agent or legal representative cannot file it on your behalf.", "choices": [{"label": "True", "text": "True"}, {"label": "False", "text": "False"}], "correct_answer": "False", "explanation": "This is false. Your insurance agent, broker, or legal representative can also file the collision report to law enforcement on your behalf.", "section_id": "section-10", "topic": "Collisions", "subtopic": "What to Do if You Are in a Collision", "difficulty": "medium", "image_id": null, "image_file": null, "source_facts": ["Your insurance agent, broker, or legal representative can also file the collision report to law enforcement."], "validation_status": "pass", "validation_notes": null, "ranking": {"frequency": 6, "quality": 7, "importance": 6, "uniqueness": 6, "composite": 6.2, "rank": 47}, "_image_data_uri": null}, {"question_id": "q-sec10-collisions-005", "question_type": "true_false", "question_text": "Not following the right-of-way rules rarely causes collisions.", "choices": [{"label": "True", "text": "True"}, {"label": "False", "text": "False"}], "correct_answer": "False", "explanation": "This is false. Not following the right-of-way rules is listed as one of the most common causes of collisions in the California Driver Handbook.", "section_id": "section-10", "topic": "Collisions", "subtopic": "Causes of Collisions", "difficulty": "easy", "image_id": null, "image_file": null, "source_facts": ["Not following the right-of-way rules is a common cause of collisions."], "validation_status": "pass", "validation_notes": null, "ranking": {"frequency": 7, "quality": 6, "importance": 7, "uniqueness": 4, "composite": 6.1, "rank": 48}, "_image_data_uri": null}, {"question_id": "q-sec10-collisions-006", "question_type": "true_false", "question_text": "Not following stop signals and signs is an uncommon cause of collisions.", "choices": [{"label": "True", "text": "True"}, {"label": "False", "text": "False"}], "correct_answer": "False", "explanation": "This is false. Not following stop signals and signs is one of the most common causes of collisions listed in the California Driver Handbook.", "section_id": "section-10", "topic": "Collisions", "subtopic": "Causes of Collisions", "difficulty": "easy", "image_id": null, "image_file": null, "source_facts": ["Not following stop signals and signs is a common cause of collisions."], "validation_status": "pass", "validation_notes": null, "ranking": {"frequency": 7, "quality": 6, "importance": 7, "uniqueness": 4, "composite": 6.1, "rank": 49}, "_image_data_uri": null}, {"question_id": "q-sec10-collisions-007", "question_type": "true_false", "question_text": "Driving on the wrong side of the road is a common cause of collisions.", "choices": [{"label": "True", "text": "True"}, {"label": "False", "text": "False"}], "correct_answer": "True", "explanation": "Driving on the wrong side of the road is listed as one of the most common causes of collisions in the handbook.", "section_id": "section-10", "topic": "Collisions", "subtopic": "Causes of Collisions", "difficulty": "easy", "image_id": null, "image_file": null, "source_facts": ["Driving on the wrong side of the road is a common cause of collisions."], "validation_status": "pass", "validation_notes": null, "ranking": {"frequency": 6, "quality": 6, "importance": 7, "uniqueness": 4, "composite": 5.8, "rank": 50}, "_image_data_uri": null}, {"question_id": "q-sec10-insurance-requirements-012", "question_type": "true_false", "question_text": "You can check whether an insurance provider is licensed by visiting dmv.ca.gov/insurance.", "choices": [{"label": "True", "text": "True"}, {"label": "False", "text": "False"}], "correct_answer": "False", "explanation": "This is false. The correct website to check whether an insurance agent, broker, or provider is licensed is insurance.ca.gov/license-status/, not dmv.ca.gov/insurance. The California Department of Insurance (not the DMV) handles insurance licensing.", "section_id": "section-10", "topic": "Insurance Requirements", "subtopic": "Verifying Insurance Providers", "difficulty": "easy", "image_id": null, "image_file": null, "source_facts": ["The handbook provides insurance.ca.gov/license-status/ for more information about insurance license status."], "validation_status": "pass", "validation_notes": null, "ranking": {"frequency": 5, "quality": 7, "importance": 5, "uniqueness": 6, "composite": 5.7, "rank": 51}, "_image_data_uri": null}, {"question_id": "q-sec10-collisions-019", "question_type": "true_false", "question_text": "If you injure an animal while driving, you should try to move it off the road.", "choices": [{"label": "True", "text": "True"}, {"label": "False", "text": "False"}], "correct_answer": "False", "explanation": "Do not try to move an injured animal. Instead, call the nearest humane society or law enforcement for assistance.", "section_id": "section-10", "topic": "Collisions", "subtopic": "What to Do if You Are in a Collision", "difficulty": "medium", "image_id": null, "image_file": null, "source_facts": ["Do not try to move an injured animal."], "validation_status": "pass", "validation_notes": null, "ranking": {"frequency": 6, "quality": 6, "importance": 6, "uniqueness": 4, "composite": 5.6, "rank": 52}, "_image_data_uri": null}, {"question_id": "q-sec10-low-cost-insurance-002", "question_type": "true_false", "question_text": "You can call 1-866-602-8861 for information about the California Low Cost Automobile Insurance Program.", "choices": [{"label": "True", "text": "True"}, {"label": "False", "text": "False"}], "correct_answer": "True", "explanation": "The handbook states that for more information about the California Low Cost Automobile Insurance Program, you can visit mylowcostauto.com or call 1-866-602-8861.", "section_id": "section-10", "topic": "Low-cost Insurance", "subtopic": "California Low Cost Automobile Insurance Program", "difficulty": "easy", "image_id": null, "image_file": null, "source_facts": ["For more information about the California Low Cost Automobile Insurance Program, visit mylowcostauto.com or call 1-866-602-8861."], "validation_status": "pass", "validation_notes": null, "ranking": {"frequency": 4, "quality": 5, "importance": 4, "uniqueness": 5, "composite": 4.5, "rank": 53}, "_image_data_uri": null}]');

/* ---- State ---- */
var filtered = [];       // Current filtered/shuffled question list (indices into ALL_QUESTIONS)
var currentIdx = 0;      // Index into filtered[]
var answers = {};        // questionIndex -> selected choice index
var revealed = {};       // questionIndex -> true if answer was revealed
var choiceOrder = {};     // questionIndex -> shuffled indices array for choices

/* ---- DOM refs ---- */
var $counter = document.getElementById('q-counter');
var $sectionLabel = document.getElementById('q-section-label');
var $topicLabel = document.getElementById('q-topic-label');
var $difficultyLabel = document.getElementById('q-difficulty-label');
var $imageWrapper = document.getElementById('q-image-wrapper');
var $image = document.getElementById('q-image');
var $text = document.getElementById('q-text');
var $choices = document.getElementById('choices-container');
var $feedback = document.getElementById('feedback');
var $feedbackText = document.getElementById('feedback-text');
var $explanation = document.getElementById('explanation');
var $btnShow = document.getElementById('btn-show-answer');
var $btnPrev = document.getElementById('btn-prev');
var $btnNext = document.getElementById('btn-next');
var $progressBar = document.getElementById('progress-bar');
var $scoreCorrect = document.getElementById('score-correct');
var $scoreIncorrect = document.getElementById('score-incorrect');
var $scoreUnanswered = document.getElementById('score-unanswered');
var $questionContainer = document.getElementById('question-container');
var $summaryContainer = document.getElementById('summary-container');
var $emptyState = document.getElementById('empty-state');
var $filterSection = document.getElementById('filter-section');
var $filterTopic = document.getElementById('filter-topic');
var $filterDifficulty = document.getElementById('filter-difficulty');
var $filterType = document.getElementById('filter-type');
var $btnShuffle = document.getElementById('btn-shuffle');
var $btnReset = document.getElementById('btn-reset');

/* ---- Helpers ---- */
function escapeHtml(str) {
  var div = document.createElement('div');
  div.appendChild(document.createTextNode(str || ''));
  return div.innerHTML;
}

function getField(q, names, fallback) {
  for (var i = 0; i < names.length; i++) {
    if (q[names[i]] !== undefined && q[names[i]] !== null && q[names[i]] !== '') return q[names[i]];
  }
  return fallback || '';
}

function getSection(q) { return getField(q, ['section', 'section_id', 'section_title'], 'Unknown'); }
function getTopic(q) { return getField(q, ['topic', 'topic_title', 'topic_id'], ''); }
function getDifficulty(q) { return getField(q, ['difficulty', 'difficulty_level'], ''); }
function getType(q) { return getField(q, ['question_type', 'type'], 'multiple_choice'); }
function getQuestionText(q) { return getField(q, ['question_text', 'question', 'text'], ''); }
function getExplanation(q) { return getField(q, ['explanation', 'rationale', 'answer_explanation'], ''); }

function getChoices(q) {
  // Choices may be an array of strings or an array of objects with label/text keys.
  var raw = q.choices || q.options || q.answers || [];
  var result = [];
  for (var i = 0; i < raw.length; i++) {
    var c = raw[i];
    if (typeof c === 'string') {
      result.push(c);
    } else if (c && typeof c === 'object') {
      result.push(c.text || c.label || c.value || c.choice || JSON.stringify(c));
    } else {
      result.push(String(c));
    }
  }
  // For true_false questions with no explicit choices, supply them.
  if (result.length === 0 && getType(q) === 'true_false') {
    result = ['True', 'False'];
  }
  return result;
}

function getCorrectIndex(q) {
  // correct_answer may be an index (int), a letter (A/B/C/D), or the answer text.
  var ca = q.correct_answer !== undefined ? q.correct_answer : (q.answer !== undefined ? q.answer : null);
  if (ca === null || ca === undefined) return -1;
  var choices = getChoices(q);
  // Integer index
  if (typeof ca === 'number') return ca;
  var s = String(ca).trim();
  // Single letter A-Z
  if (/^[A-Za-z]$/.test(s)) {
    var idx = s.toUpperCase().charCodeAt(0) - 65;
    if (idx >= 0 && idx < choices.length) return idx;
  }
  // Letter with parentheses or period: "A)" or "A."
  var letterMatch = s.match(/^([A-Za-z])[\).:\s]/);
  if (letterMatch) {
    var li = letterMatch[1].toUpperCase().charCodeAt(0) - 65;
    if (li >= 0 && li < choices.length) return li;
  }
  // Exact text match
  for (var i = 0; i < choices.length; i++) {
    if (choices[i].trim() === s) return i;
  }
  // Substring match (correct_answer text contained in a choice)
  for (var j = 0; j < choices.length; j++) {
    if (choices[j].toLowerCase().indexOf(s.toLowerCase()) !== -1) return j;
    if (s.toLowerCase().indexOf(choices[j].toLowerCase()) !== -1) return j;
  }
  // Numeric string
  var num = parseInt(s, 10);
  if (!isNaN(num) && num >= 0 && num < choices.length) return num;
  return -1;
}

/* ---- Filter population ---- */
function populateFilters() {
  var sections = {}, topics = {}, difficulties = {}, types = {};
  for (var i = 0; i < ALL_QUESTIONS.length; i++) {
    var q = ALL_QUESTIONS[i];
    var s = getSection(q); if (s) sections[s] = true;
    var t = getTopic(q); if (t) topics[t] = true;
    var d = getDifficulty(q); if (d) difficulties[d] = true;
    var tp = getType(q); if (tp) types[tp] = true;
  }
  fillSelect($filterSection, sections);
  fillSelect($filterTopic, topics);
  fillSelect($filterDifficulty, difficulties);
  fillSelect($filterType, types);
}

function fillSelect(el, map) {
  var keys = Object.keys(map).sort();
  for (var i = 0; i < keys.length; i++) {
    var opt = document.createElement('option');
    opt.value = keys[i];
    opt.textContent = keys[i];
    el.appendChild(opt);
  }
}

/* ---- Filtering ---- */
function applyFilters() {
  var sv = $filterSection.value;
  var tv = $filterTopic.value;
  var dv = $filterDifficulty.value;
  var tpv = $filterType.value;
  filtered = [];
  for (var i = 0; i < ALL_QUESTIONS.length; i++) {
    var q = ALL_QUESTIONS[i];
    if (sv !== 'all' && getSection(q) !== sv) continue;
    if (tv !== 'all' && getTopic(q) !== tv) continue;
    if (dv !== 'all' && getDifficulty(q) !== dv) continue;
    if (tpv !== 'all' && getType(q) !== tpv) continue;
    filtered.push(i);
  }
  shuffleArray(filtered);
  currentIdx = 0;
  updateView();
}

/* ---- Shuffle ---- */
function shuffleArray(arr) {
  for (var i = arr.length - 1; i > 0; i--) {
    var j = Math.floor(Math.random() * (i + 1));
    var tmp = arr[i]; arr[i] = arr[j]; arr[j] = tmp;
  }
}

function identityArray(n) {
  var arr = [];
  for (var i = 0; i < n; i++) arr.push(i);
  return arr;
}

function initChoiceOrders() {
  choiceOrder = {};
  for (var i = 0; i < ALL_QUESTIONS.length; i++) {
    var q = ALL_QUESTIONS[i];
    var choices = getChoices(q);
    var type = getType(q);
    if (type === 'true_false' || choices.length <= 2) {
      choiceOrder[i] = identityArray(choices.length);
    } else {
      var arr = identityArray(choices.length);
      shuffleArray(arr);
      choiceOrder[i] = arr;
    }
  }
}

/* ---- Score calculation ---- */
function calcScores() {
  var correct = 0, incorrect = 0, unanswered = 0;
  for (var i = 0; i < filtered.length; i++) {
    var qi = filtered[i];
    if (revealed[qi] && answers[qi] !== undefined) {
      var q = ALL_QUESTIONS[qi];
      if (answers[qi] === getCorrectIndex(q)) correct++;
      else incorrect++;
    } else {
      unanswered++;
    }
  }
  return { correct: correct, incorrect: incorrect, unanswered: unanswered, total: filtered.length };
}

function updateScoreDisplay() {
  var s = calcScores();
  $scoreCorrect.textContent = 'Correct: ' + s.correct;
  $scoreIncorrect.textContent = 'Incorrect: ' + s.incorrect;
  $scoreUnanswered.textContent = 'Remaining: ' + s.unanswered;
  // Progress bar: answered / total
  var pct = s.total > 0 ? ((s.correct + s.incorrect) / s.total * 100) : 0;
  $progressBar.style.width = pct + '%';
}

/* ---- Rendering ---- */
function renderQuestion() {
  if (filtered.length === 0) {
    $questionContainer.style.display = 'none';
    $summaryContainer.style.display = 'none';
    $emptyState.style.display = 'block';
    updateScoreDisplay();
    return;
  }
  $emptyState.style.display = 'none';
  $summaryContainer.style.display = 'none';
  $questionContainer.style.display = 'block';

  var qi = filtered[currentIdx];
  var q = ALL_QUESTIONS[qi];

  // Counter
  $counter.textContent = 'Question ' + (currentIdx + 1) + ' of ' + filtered.length;

  // Meta tags
  $sectionLabel.textContent = getSection(q);
  var topic = getTopic(q);
  $topicLabel.textContent = topic;
  $topicLabel.style.display = topic ? '' : 'none';
  var diff = getDifficulty(q);
  $difficultyLabel.textContent = diff;
  $difficultyLabel.style.display = diff ? '' : 'none';

  // Image
  var imgUri = q._image_data_uri;
  if (imgUri) {
    $image.src = imgUri;
    $imageWrapper.style.display = 'block';
  } else {
    $imageWrapper.style.display = 'none';
    $image.src = '';
  }

  // Question text
  $text.innerHTML = escapeHtml(getQuestionText(q));

  // Choices
  var choices = getChoices(q);
  var order = choiceOrder[qi] || identityArray(choices.length);
  $choices.innerHTML = '';
  var isRevealed = !!revealed[qi];
  var selectedIdx = answers[qi];
  var correctIdx = getCorrectIndex(q);
  var letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';

  for (var i = 0; i < order.length; i++) {
    var origIdx = order[i];
    var btn = document.createElement('button');
    btn.className = 'choice-btn';
    btn.setAttribute('data-idx', i);

    var letterSpan = document.createElement('span');
    letterSpan.className = 'choice-letter';
    letterSpan.textContent = (i < letters.length ? letters[i] : (i + 1)) + '.';

    var textSpan = document.createElement('span');
    textSpan.className = 'choice-text';
    textSpan.textContent = choices[origIdx];

    btn.appendChild(letterSpan);
    btn.appendChild(textSpan);

    // Styling based on state
    if (isRevealed) {
      if (origIdx === correctIdx) {
        btn.classList.add('choice-correct');
      }
      if (selectedIdx !== undefined && origIdx === selectedIdx && origIdx !== correctIdx) {
        btn.classList.add('choice-incorrect');
      }
      btn.disabled = true;
    } else if (selectedIdx !== undefined && origIdx === selectedIdx) {
      btn.classList.add('choice-selected');
    }

    btn.addEventListener('click', (function(idx) {
      return function() { selectChoice(idx); };
    })(origIdx));

    $choices.appendChild(btn);
  }

  // Feedback
  if (isRevealed) {
    var displayCorrectPos = order.indexOf(correctIdx);
    $feedback.style.display = 'block';
    if (selectedIdx === correctIdx) {
      $feedbackText.textContent = 'Correct!';
      $feedbackText.className = 'feedback-correct';
    } else if (selectedIdx !== undefined && selectedIdx >= 0) {
      $feedbackText.textContent = 'Incorrect. The correct answer is ' + (displayCorrectPos < letters.length ? letters[displayCorrectPos] : (displayCorrectPos + 1)) + '.';
      $feedbackText.className = 'feedback-incorrect';
    } else {
      $feedbackText.textContent = 'No answer selected. The correct answer is ' + (displayCorrectPos < letters.length ? letters[displayCorrectPos] : (displayCorrectPos + 1)) + '.';
      $feedbackText.className = 'feedback-incorrect';
    }
    var expl = getExplanation(q);
    if (expl) {
      $explanation.style.display = 'block';
      $explanation.innerHTML = '<strong>Explanation:</strong> ' + escapeHtml(expl);
    } else {
      $explanation.style.display = 'none';
    }
    $btnShow.style.display = 'none';
  } else {
    $feedback.style.display = 'none';
    $explanation.style.display = 'none';
    $btnShow.style.display = '';
  }

  // Nav buttons
  $btnPrev.disabled = (currentIdx === 0);
  $btnNext.textContent = (currentIdx === filtered.length - 1) ? 'Finish' : 'Next \u2192';

  updateScoreDisplay();
}

function selectChoice(idx) {
  var qi = filtered[currentIdx];
  if (revealed[qi]) return;
  answers[qi] = idx;
  renderQuestion();
}

function revealAnswer() {
  var qi = filtered[currentIdx];
  revealed[qi] = true;
  if (answers[qi] === undefined) {
    answers[qi] = -1;
  }
  renderQuestion();
}

function goNext() {
  if (currentIdx < filtered.length - 1) {
    currentIdx++;
    renderQuestion();
    window.scrollTo(0, 0);
  } else {
    showSummary();
  }
}

function goPrev() {
  if (currentIdx > 0) {
    currentIdx--;
    renderQuestion();
    window.scrollTo(0, 0);
  }
}

/* ---- Summary ---- */
function showSummary() {
  $questionContainer.style.display = 'none';
  $emptyState.style.display = 'none';
  $summaryContainer.style.display = 'block';

  var s = calcScores();
  var pct = s.total > 0 ? Math.round(s.correct / s.total * 100) : 0;
  var passed = pct >= 83;  // CA DMV passing score

  document.getElementById('summary-score').innerHTML =
    '<div class="summary-big-score">' + s.correct + ' / ' + s.total + '</div>' +
    '<div class="summary-pct ' + (passed ? 'summary-pass' : 'summary-fail') + '">' + pct + '%' +
    (passed ? ' -- PASS' : ' -- NEEDS PRACTICE') + '</div>' +
    '<div class="summary-detail">' +
    '<span class="score-chip correct-chip">Correct: ' + s.correct + '</span> ' +
    '<span class="score-chip incorrect-chip">Incorrect: ' + s.incorrect + '</span> ' +
    '<span class="score-chip unanswered-chip">Unanswered: ' + s.unanswered + '</span>' +
    '</div>';

  // Breakdown by section
  var sectionStats = {};
  for (var i = 0; i < filtered.length; i++) {
    var qi = filtered[i];
    var q = ALL_QUESTIONS[qi];
    var sec = getSection(q);
    if (!sectionStats[sec]) sectionStats[sec] = { correct: 0, incorrect: 0, unanswered: 0, total: 0 };
    sectionStats[sec].total++;
    if (revealed[qi] && answers[qi] !== undefined) {
      if (answers[qi] === getCorrectIndex(q)) sectionStats[sec].correct++;
      else sectionStats[sec].incorrect++;
    } else {
      sectionStats[sec].unanswered++;
    }
  }
  var bhtml = '<h3>Breakdown by Section</h3><table class="breakdown-table"><thead><tr><th>Section</th><th>Correct</th><th>Incorrect</th><th>Unanswered</th><th>Score</th></tr></thead><tbody>';
  var skeys = Object.keys(sectionStats).sort();
  for (var j = 0; j < skeys.length; j++) {
    var st = sectionStats[skeys[j]];
    var sp = st.total > 0 ? Math.round(st.correct / st.total * 100) : 0;
    bhtml += '<tr><td>' + escapeHtml(skeys[j]) + '</td><td>' + st.correct + '</td><td>' + st.incorrect + '</td><td>' + st.unanswered + '</td><td>' + sp + '%</td></tr>';
  }
  bhtml += '</tbody></table>';
  document.getElementById('summary-breakdown').innerHTML = bhtml;

  updateScoreDisplay();
}

/* ---- Main view toggle ---- */
function updateView() {
  renderQuestion();
}

/* ---- Reset ---- */
function resetAll() {
  answers = {};
  revealed = {};
  initChoiceOrders();
  shuffleArray(filtered);
  currentIdx = 0;
  updateView();
}

/* ---- Event listeners ---- */
$btnShow.addEventListener('click', revealAnswer);
$btnNext.addEventListener('click', goNext);
$btnPrev.addEventListener('click', goPrev);
$filterSection.addEventListener('change', applyFilters);
$filterTopic.addEventListener('change', applyFilters);
$filterDifficulty.addEventListener('change', applyFilters);
$filterType.addEventListener('change', applyFilters);
$btnShuffle.addEventListener('click', function() {
  shuffleArray(filtered);
  currentIdx = 0;
  updateView();
});
$btnReset.addEventListener('click', resetAll);
document.getElementById('btn-review').addEventListener('click', function() {
  currentIdx = 0;
  $summaryContainer.style.display = 'none';
  $questionContainer.style.display = 'block';
  renderQuestion();
});
document.getElementById('btn-restart').addEventListener('click', function() {
  resetAll();
  $summaryContainer.style.display = 'none';
});

// Keyboard navigation
document.addEventListener('keydown', function(e) {
  if ($summaryContainer.style.display !== 'none') return;
  if ($questionContainer.style.display === 'none') return;
  if (e.key === 'ArrowRight' || e.key === 'n') goNext();
  else if (e.key === 'ArrowLeft' || e.key === 'p') goPrev();
  else if (e.key === 'Enter' || e.key === ' ') {
    var qi = filtered[currentIdx];
    if (!revealed[qi]) { e.preventDefault(); revealAnswer(); }
  }
  else if (e.key >= '1' && e.key <= '9') {
    var ci = parseInt(e.key, 10) - 1;
    var qi2 = filtered[currentIdx];
    var order2 = choiceOrder[qi2] || [];
    if (!revealed[qi2] && ci < order2.length) selectChoice(order2[ci]);
  }
  else if (e.key >= 'a' && e.key <= 'z' && e.key.length === 1) {
    var ci2 = e.key.charCodeAt(0) - 97;
    var qi3 = filtered[currentIdx];
    var order3 = choiceOrder[qi3] || [];
    if (!revealed[qi3] && ci2 < order3.length) selectChoice(order3[ci2]);
  }
});

/* ---- Init ---- */
initChoiceOrders();
populateFilters();
applyFilters();

})();
</script>
</body>
</html>